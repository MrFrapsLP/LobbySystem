name: Build Windows EXE

on:
  workflow_dispatch:
    inputs:
      entry_script:
        description: "Pfad zur Python-Startdatei (optional), z. B. game.py oder src/game.py"
        required: true
        default: "game.py"
  push:
    branches:
      - main
      - work

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyInstaller
        run: python -m pip install --upgrade pip pyinstaller

      - name: Resolve entry script path
        shell: pwsh
        run: |
          $manualInput = "${{ github.event.inputs.entry_script }}".Trim()
          Write-Host "Aktueller Branch/Ref: $env:GITHUB_REF"
          $candidate = $null

          if ($manualInput -ne "") {
            if (Test-Path $manualInput) {
              $candidate = Get-Item $manualInput
              Write-Host "Nutze manuell angegebenes Script: $($candidate.FullName)"
            } else {
              Write-Error "Angegebenes Script '$manualInput' wurde nicht gefunden."
              exit 1
            }
          }

          if (-not $candidate) {
            $preferred = @("game.py", "main.py", "app.py")
            foreach ($name in $preferred) {
              $candidate = Get-ChildItem -Path . -Recurse -File -Filter $name | Select-Object -First 1
              if ($candidate) {
                Write-Host "Automatisch gefundenes Script: $($candidate.FullName)"
                break
              }
            }
          }

          if (-not $candidate) {
            $candidate = Get-ChildItem -Path . -Recurse -File -Include *.py |
              Where-Object { $_.FullName -notmatch "\\.venv\\|\\venv\\|\\site-packages\\|\\tests?\\" } |
              Select-Object -First 1
            if ($candidate) {
              Write-Host "Fallback Script verwendet: $($candidate.FullName)"
            }
          }

          if (-not $candidate) {
            Write-Host "Gefundene Dateien im Repo:"
            Get-ChildItem -Path . -Recurse -File | Select-Object -ExpandProperty FullName

            $fallbackPath = Join-Path $env:GITHUB_WORKSPACE "fallback_notice.py"
            if (Test-Path $fallbackPath) {
              Write-Warning "Keine Python-Startdatei gefunden. Es wird fallback_notice.py als Hinweis-EXE gebaut."
              $candidate = Get-Item $fallbackPath
            } else {
              Write-Warning "Keine Python-Startdatei und keine fallback_notice.py gefunden. Erzeuge tempor√§res Hinweis-Script."
              $tempFallbackPath = Join-Path $env:RUNNER_TEMP "fallback_notice_generated.py"
              @(
                'import tkinter as tk',
                '',
                'root = tk.Tk()',
                'root.title("Kitchen Hustle")',
                'root.geometry("520x260")',
                'label = tk.Label(root, text="Kein Python-Startscript im Repo gefunden.\nBitte setze im Workflow das Feld entry_script.", padx=20, pady=20, justify="center")',
                'label.pack(expand=True)',
                'root.mainloop()'
              ) | Set-Content -Path $tempFallbackPath -Encoding UTF8
              $candidate = Get-Item $tempFallbackPath
            }
          }

          "GAME_SCRIPT=$($candidate.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build EXE
        shell: pwsh
        run: pyinstaller --noconfirm --onefile --windowed --name KitchenHustle "$env:GAME_SCRIPT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: KitchenHustle-windows-exe
          path: dist/KitchenHustle.exe
